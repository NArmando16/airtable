<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0"
  />
  <title>Importar CSV al backend</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <main class="container">
    <section class="card">
      <h1>Subir CSV del d√≠a al backend</h1>

      <p style="margin-bottom: 0.8rem; font-size: 0.9rem; color: #9ca3af;">
        Este archivo NO va a la cola de este celular, se env√≠a al servidor
        (<strong>una sola vez por d√≠a</strong>).<br />
        Luego cada celular usa el bot√≥n
        <strong>‚ÄúCargar √≥rdenes de hoy desde servidor‚Äù</strong> en el gestor
        principal.
      </p>

      <p style="margin-bottom: 0.5rem;">
        Backend actual:
        <strong id="backendUrlLabel"></strong>
      </p>

      <div class="field-group">
        <label for="csvFile" class="field-label">
          Archivo CSV del d√≠a
        </label>
        <input
          id="csvFile"
          type="file"
          name="file"
          accept=".csv,text/csv"
          class="text-input"
        />
      </div>

      <div class="controls">
        <button id="uploadBtn" class="btn">
          üì• Subir CSV al backend
        </button>
        <a href="index.html" class="copy-btn">
          ‚¨Ö Volver al gestor
        </a>
      </div>

      <h2 style="margin-top: 1.5rem;">Limpiar datos del backend</h2>
      <button
        id="resetBackendBtn"
        type="button"
        class="btn"
        style="background:#b91c1c;"
      >
        üî• Borrar todas las √≥rdenes del backend
      </button>
      <p style="font-size:0.8rem; color:#9ca3af; margin-top:0.3rem;">
        √ösalo solo si subiste un CSV equivocado o quieres empezar totalmente
        desde cero.
      </p>

      <pre
        id="result"
        class="text-block"
        style="margin-top:1rem; font-size:0.85rem; white-space:pre-wrap;"
      ></pre>
    </section>
  </main>

  <script>
    // üëá URL de tu backend en Render
    const BACKEND_BASE_URL = "https://backend-airtable-nxyk.onrender.com";

    const backendLabel = document.getElementById("backendUrlLabel");
    const fileInput = document.getElementById("csvFile");
    const uploadBtn = document.getElementById("uploadBtn");
    const resetBtn = document.getElementById("resetBackendBtn");
    const resultEl = document.getElementById("result");

    backendLabel.textContent = BACKEND_BASE_URL;

    // Subir CSV al backend
    uploadBtn.addEventListener("click", async () => {
      const file = fileInput.files[0];
      if (!file) {
        alert("Primero selecciona el CSV del d√≠a.");
        return;
      }

      const formData = new FormData();
      formData.append("file", file);

      resultEl.textContent = "Subiendo CSV al backend, espera...";

      try {
        const resp = await fetch(BACKEND_BASE_URL + "/api/import-csv", {
          method: "POST",
          body: formData
        });

        const data = await resp.json();
        resultEl.textContent = JSON.stringify(data, null, 2);
      } catch (err) {
        console.error(err);
        resultEl.textContent = "Error subiendo CSV: " + err.message;
      }
    });

    // Resetear backend (borrar todas las √≥rdenes en memoria)
    resetBtn.addEventListener("click", async () => {
      const ok = confirm(
        "‚ö† Esto borrar√° TODAS las √≥rdenes del backend (todos los workers y celulares).\n\n¬øSeguro que quieres continuar?"
      );
      if (!ok) return;

      resultEl.textContent = "Limpiando backend...";

      try {
        const resp = await fetch(BACKEND_BASE_URL + "/api/reset-store", {
          method: "POST"
        });
        const data = await resp.json();
        resultEl.textContent = JSON.stringify(data, null, 2);
      } catch (err) {
        console.error(err);
        resultEl.textContent = "Error limpiando backend: " + err.message;
      }
    });
  </script>
</body>
</html>
